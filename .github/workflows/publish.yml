name: PUBLISH

on:
  workflow_dispatch:
  push:
    tags:
      - "**"

jobs:
  all-build:
    name: Build All Artifacts
    if: github.event_name == 'push'
    uses: ./.github/workflows/build.yml
    secrets: inherit
    concurrency:
      group: BUILD-${{ github.ref }}

  all-release-publish:
    name: Create Release For All Files
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: all-build
    concurrency:
      group: PUBLISH-${{ github.ref }}
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4

      - name: Download Viridian Algae Artifact 🌿
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: publish.yml
          run_id: ${{ github.run_id }}
          allow_forks: false
          name: viridian-algae-executable-.+
          name_is_regexp: true

      - name: Download Caerulean Whirlpool Artifact 🌌
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: publish.yml
          run_id: ${{ github.run_id }}
          allow_forks: false
          name: caerulean-whirlpool-executable-.+
          name_is_regexp: true

      - name: Download Viridian Reef Artifact 🪸
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: publish.yml
          run_id: ${{ github.run_id }}
          allow_forks: false
          name: viridian-reef-executable-.+
          name_is_regexp: true

      - name: Create Release 🪅
        uses: marvinpinto/action-automatic-releases@v1.2.1
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          files: |
            **/*.run
            **/*.exe
            **/*.pyz

  caerulean-whirlpool-deploy:
    name: Deploy Caerulean Whirlpool To Dedicated Test Server
    runs-on: ubuntu-latest
    needs: all-release-publish
    concurrency:
      group: DEPLOY-${{ github.ref }}

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4

      - name: Install NodeJS 🪢
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Node Dependencies 🔮
        working-directory: .github/scripts
        run: npm install

      - name: Setup Python 3.11 🐍
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies 🔮
        working-directory: viridian/algae
        run: |
          pip3 install poetry
          poetry install --extras "bundle setup"

      - name: Deploy Caerulean Whirlpool 🚀
        working-directory: .github/scripts
        env:
          SERVAONE_API_EMAIL: ${{ secrets.SERVAONE_API_EMAIL }}
          SERVAONE_API_TOKEN: ${{ secrets.SERVAONE_API_TOKEN }}
          SERVAONE_SERVER_PASSWORD: ${{ secrets.SERVAONE_SERVER_PASSWORD }}
          SERVAONE_SERVER_KEY: ${{ secrets.SERVAONE_SERVER_KEY }}
        run: npm run deploy-whirlpool-servaone -- -v
